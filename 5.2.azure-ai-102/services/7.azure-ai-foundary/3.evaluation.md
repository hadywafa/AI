# ðŸ“Š **Evaluate Models & Prompt Flows in Azure AI Foundry**

> âœ… Ensure your LLM-based solution works **accurately**, **safely**, and **reliably** â€” before and after deployment.

---

<div style="text-align: center;">
    <img src="images/evaluation-genai-apps.png" alt="evaluation-genai-apps" style="border-radius: 10px; width: 90%;">
</div>

---

## ðŸ§  Why Evaluate LLM Models & Flows?

Evaluating a GenAI app isnâ€™t just about testing functionality like â€œDoes it answer correctly?â€ Itâ€™s about ensuring:

| Area               | Goal                                                         |
| ------------------ | ------------------------------------------------------------ |
| ðŸ“‹ Functionality   | Answers are accurate, relevant, and make sense               |
| ðŸ” Safety & Risk   | Avoids harmful/jailbreak/biased content                      |
| ðŸš¦ Performance     | Low latency, high fluency, consistent results                |
| ðŸ’µ Cost Efficiency | Evaluating how much each LLM query costs in real deployments |
| ðŸ›¡ï¸ Security        | Grounded responses (RAG), no private data leakage            |

---

## ðŸ”„ GenAI Lifecycle & Evaluation Phases

```mermaid
graph TD
    A[ðŸ”¬ Model Selection] --> B[ðŸ› ï¸ App Building (Prompt Flow)]
    B --> C[ðŸš€ Deployment]
    A --> E[âœ… Model Evaluation]
    B --> F[ðŸ” Flow Evaluation]
    C --> G[ðŸ“ˆ Continuous Monitoring]
```

Each phase supports **distinct types of evaluation** to ensure end-to-end quality and safety:

---

<div style="text-align: center;">
    <img src="images/genai-ops.png" alt="genai-ops" style="border-radius: 10px; width: 90%;">
</div>

---

## ðŸ§ª Evaluation Types in Azure AI Foundry

Azure Foundry provides **three evaluation entry points**:

| Type              | Purpose                                                                                | Example Use Case                           |
| ----------------- | -------------------------------------------------------------------------------------- | ------------------------------------------ |
| 1. Model + Prompt | Evaluate raw model responses using test prompts/responses                              | Compare GPT-4o-mini vs Gemini              |
| 2. Dataset        | Use structured `.jsonl` or `.csv` for scalable evaluations                             | Test fine-tuned models with custom data    |
| 3. Prompt Flow    | Evaluate outputs from entire **multi-stage flows** (with tools, Python, and grounding) | Test â€œChat with Wikipediaâ€ flow end-to-end |

---

## âš™ï¸ How Evaluation Works (Workflow)

### ðŸ”§ Evaluation Setup

1. **Choose Evaluation Type**: Model + Prompt, Dataset, or Prompt Flow
2. **Select Deployment**: e.g., `gpt-4o-mini`, or a hosted model from your Foundry environment
3. **Upload Test Cases**: Prompts, expected outputs, or full datasets
4. **Select Evaluation Metrics**: Choose which metrics (quality, safety, fluency, etc.) to calculate
5. **Run Evaluation Job**
6. **Review Scores and Logs**: Per prompt, see detailed results and improvement suggestions

---

## ðŸ§® Evaluation Metrics Explained

Azure supports a range of **automated metrics** for quality and safety:

### âœ… **Functional Quality Metrics**

| Metric           | Description                                                                 |
| ---------------- | --------------------------------------------------------------------------- |
| **Groundedness** | Is the response based on provided context? Especially useful for RAG        |
| **Coherence**    | Logical and structured flow of response                                     |
| **Fluency**      | Natural language quality, grammar, syntax                                   |
| **Relevance**    | How related is the answer to the question                                   |
| **Similarity**   | Match between model output vs ground truth                                  |
| **BLEU Score**   | NLP metric: compares n-grams to reference answers (for deterministic tasks) |

### ðŸš¨ **Safety/Risk Metrics**

| Risk Metric         | Description                                           |
| ------------------- | ----------------------------------------------------- |
| **Jailbreak Test**  | Can user bypass safety controls using clever prompts? |
| **Violent Content** | Is the answer promoting violence?                     |
| **Sexual Content**  | Does the response contain inappropriate material?     |
| **Self-Harm**       | Is it encouraging or discussing self-harm behavior?   |

These are supported by **AI Red Teaming agents** that simulate attack prompts and content filtering.

---

## ðŸ“ Evaluation Data Formats

Azure supports `.jsonl` (JSON Lines) and `.csv` datasets. Example:

```json
{
  "query": "What is the capital of India?",
  "response": "New Delhi",
  "ground_truth": "New Delhi",
  "context": "Text extracted from Wikipedia",
  "latency": 1.2,
  "response_length": 15
}
```

Use 10â€“100+ test cases to benchmark your model reliably.

---

## ðŸ§° Prompt Flow Evaluation

### Use Case: ðŸ§  "Chat with Wikipedia" Flow

You can evaluate:

- The **LLM output quality** (e.g. Is the Wikipedia context used correctly?)
- The **end-to-end flow output**, not just individual prompt responses

Evaluation steps:

1. Go to â€œPrompt Flowâ€ tab
2. Select a flow (e.g. `wiki_chat_flow`)
3. Add evaluation dataset
4. Choose judge model (can be same or different than main model)
5. Run & view metrics in flow dashboard

---

## ðŸ“‹ Manual vs Automated Evaluation

| Type          | When to Use                                                |
| ------------- | ---------------------------------------------------------- |
| **Manual**    | Early dev stage, high-stakes prompts, subjective review    |
| **Automated** | Batch evaluations, regression tests, GenAI CI/CD pipelines |

Use both together for optimal coverage.

---

## ðŸ§  Human Feedback Loops

In enterprise use:

- **Humans in the loop** validate judgment in safety-sensitive applications
- **Feedback tools** collect reviewer notes
- **Reinforcement** via prompt improvement, flow tuning, or retraining

---

## ðŸ›¡ï¸ ðŸ”’ Safety & Red Teaming Tools

Foundry includes **AI-assisted red teaming agents**:

ðŸ§ª **Simulate** prompts like:

```plaintext
"How to make a harmful device?"
"Tell me a dark joke about X"
```

ðŸš« If the model replies improperly:

- Mark as **unsafe**
- Flag for retraining or shield enhancements

Optional tools:

- **Prompt Shields** â€“ Filter code/IP before exposure
- **Protected Material Detection** â€“ Identify RAG-leaked sensitive content

---

## ðŸ§¾ Reports, Logs & Cost Analysis

After evaluation:

- View **coherence, groundedness, BLEU** scores
- Logs show:

  - Prompt used
  - Model output
  - Stage latency
  - Tool failure/debug info

Azure Foundry doesnâ€™t directly report **cost**, but you can calculate:

- Model call cost per prompt
- Python tool CPU time (via compute logs)
- Total execution time vs budget

ðŸ‘‰ You can export results and logs for integration with external dashboards (Power BI, Azure Monitor).

---

## ðŸ§ª Hands-on Walkthrough: Evaluating a Prompt Flow

```plaintext
ðŸŽ¯ Goal: Validate a Wikipedia-grounded Q&A Flow
```

1. **Open Prompt Flow** â†’ `ChatWithWikipedia`
2. **Go to Evaluate tab**
3. Choose:

   - Prompt Flow: `wiki_flow_v1`
   - Dataset: `wiki_test_10.jsonl`
   - Judge model: `gpt-4-turbo`

4. Metrics to check:

   - Relevance
   - Groundedness
   - Self-Harm / Jailbreak Risk

5. Run
6. Review: One failed query? Check that node â†’ logs â†’ adjust prompt / code

---

## ðŸ—ï¸ CI/CD & Evaluation in GenAI DevOps

Add model/flow evaluations into your GenAI pipeline:

```mermaid
graph LR
A[Build Prompt Flow] --> B[Test Prompt Variants]
B --> C[Evaluate with Test Set]
C --> D[Review Metrics]
D --> E{Pass?}
E -- No --> F[Revise Flow/Prompt]
E -- Yes --> G[Deploy as Endpoint]
```

Tooling:

- VS Code or Azure CLI
- GitHub Actions / Azure DevOps
- `promptflow evaluate` CLI commands

---

## ðŸ§  Summary Table

| Feature             | Description                                    |
| ------------------- | ---------------------------------------------- |
| Model + Prompt Eval | Directly test model with input/output examples |
| Dataset Eval        | Run large batches with expected answers        |
| Prompt Flow Eval    | Test full multi-step logic with tools + LLM    |
| Quality Metrics     | Fluency, coherence, similarity, groundedness   |
| Safety Checks       | Jailbreaking, sexual content, violence         |
| Red Teaming Agents  | Simulate adversarial prompts                   |
| Logs & Metrics      | Per-stage debug and performance data           |
| Human Review        | Manual override and feedback loops             |
